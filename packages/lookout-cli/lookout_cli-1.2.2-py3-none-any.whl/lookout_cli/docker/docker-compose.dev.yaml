version: "3.8"
name: lookout

services:
  lookout_core:
    build:
      context: ./
      dockerfile: projects/lookout_core/Dockerfile
      args:
        GPU: ${GPU:-false}
      secrets:
        - apt_conf
        - API_TOKEN_GITHUB
    volumes:
      - ./projects/lookout_core/src:/home/ros/lookout_core/src
      - ./projects/lookout_core/data:/home/ros/lookout_core/data
      - ./projects/lookout_core/ros-ts-generator-config.json:/home/ros/lookout_core/ros-ts-generator-config.json
      - ./projects/lookout_ui/src/generated/ros:/home/ros/lookout_core/generated/ros
      - ./logs/rosbags:/home/ros/rosbags
      - ./logs/scripts:/home/ros/rosbag_scripts
      - ./.secrets/apt.conf:/etc/apt/auth.conf.d/greenroom-robotics.conf

  lookout_ui:
    image: ghcr.io/greenroom-robotics/lookout_ui:${LOOKOUT_VERSION:-latest}
    build:
      context: ./projects/lookout_ui
      secrets:
        - API_TOKEN_GITHUB
      args:
        VITE_LOOKOUT_NAMESPACE_VESSEL: $LOOKOUT_NAMESPACE_VESSEL
    environment:
      VITE_LOOKOUT_NAMESPACE_VESSEL: $LOOKOUT_NAMESPACE_VESSEL
    volumes:
      - ./projects/lookout_ui/.eslintrc.js:/app/.eslintrc.js
      - ./projects/lookout_ui/.nvmrc:/app/.nvmrc
      - ./projects/lookout_ui/.prettierrc:/app/.prettierrc
      - ./projects/lookout_ui/.yarnrc:/app/.yarnrc
      - ./projects/lookout_ui/index.html:/app/index.html
      - ./projects/lookout_ui/package.json:/app/package.json
      - ./projects/lookout_ui/public:/app/public
      - ./projects/lookout_ui/src:/app/src
      - ./projects/lookout_ui/tsconfig.json:/app/tsconfig.json
      - ./projects/lookout_ui/typings:/app/typings
      - ./projects/lookout_ui/vite.config.ts:/app/vite.config.ts
    command: yarn dev

  lookout_greenstream:
    build:
      context: .
      dockerfile: projects/lookout_greenstream/Dockerfile
      secrets:
        - apt_conf
        - API_TOKEN_GITHUB
    volumes:
      - ./projects/lookout_greenstream:/home/greenstream

  lookout_docs:
    build:
      context: ./
      dockerfile: projects/lookout_docs/Dockerfile
    volumes:
      - ./projects/lookout_docs/src:/app/src
      - ./projects/lookout_docs/static:/app/static
      - ./projects/lookout_docs/package.json:/app/package.json
      - ./projects/lookout_docs/yarn.lock:/app/yarn.lock
      - ./projects/lookout_docs/sidebars.js:/app/sidebars.js
      - ./projects/lookout_docs/docusaurus.config.js:/app/docusaurus.config.js
      - ./projects/lookout_docs/tsconfig.json:/app/tsconfig.json
      - ./docs:/app/docs
    command: yarn start

secrets:
  API_TOKEN_GITHUB:
    file: ./.secrets/API_TOKEN_GITHUB
  apt_conf:
    file: ./.secrets/apt.conf