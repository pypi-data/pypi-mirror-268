<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Deploying Gunicorn &mdash; Gunicorn 21.0.0 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Signal Handling" href="signals.html" />
    <link rel="prev" title="Instrumentation" href="instrumentation.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Gunicorn
          </a>
              <div class="version">
                21.0.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="run.html">Running Gunicorn</a></li>
<li class="toctree-l1"><a class="reference internal" href="configure.html">Configuration Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="settings.html">Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="instrumentation.html">Instrumentation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Deploying Gunicorn</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#nginx-configuration">Nginx Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="#using-virtualenv">Using Virtualenv</a></li>
<li class="toctree-l2"><a class="reference internal" href="#monitoring">Monitoring</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#gaffer">Gaffer</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#using-gafferd-and-gaffer">Using Gafferd and gaffer</a></li>
<li class="toctree-l4"><a class="reference internal" href="#using-a-procfile">Using a Procfile</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#runit">Runit</a></li>
<li class="toctree-l3"><a class="reference internal" href="#supervisor">Supervisor</a></li>
<li class="toctree-l3"><a class="reference internal" href="#upstart">Upstart</a></li>
<li class="toctree-l3"><a class="reference internal" href="#systemd">Systemd</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#logging">Logging</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="signals.html">Signal Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="custom.html">Custom Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="design.html">Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="community.html">Community</a></li>
<li class="toctree-l1"><a class="reference internal" href="news.html">Changelog</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Gunicorn</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Deploying Gunicorn</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/deploy.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="deploying-gunicorn">
<h1>Deploying Gunicorn<a class="headerlink" href="#deploying-gunicorn" title="Permalink to this heading">¶</a></h1>
<p>We strongly recommend using Gunicorn behind a proxy server.</p>
<section id="nginx-configuration">
<h2>Nginx Configuration<a class="headerlink" href="#nginx-configuration" title="Permalink to this heading">¶</a></h2>
<p>Although there are many HTTP proxies available, we strongly advise that you
use <a class="reference external" href="https://nginx.org/">Nginx</a>. If you choose another proxy server you need to make sure that it
buffers slow clients when you use default Gunicorn workers. Without this
buffering Gunicorn will be easily susceptible to denial-of-service attacks.
You can use <a class="reference external" href="https://github.com/rakyll/hey">Hey</a> to check if your proxy is behaving properly.</p>
<p>An <a class="reference external" href="https://github.com/benoitc/gunicorn/blob/master/examples/nginx.conf">example configuration</a> file for fast clients with <a class="reference external" href="https://nginx.org/">Nginx</a>:</p>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text"><strong>nginx.conf</strong></span><a class="headerlink" href="#id5" title="Permalink to this code">¶</a></div>
<div class="highlight-nginx notranslate"><div class="highlight"><pre><span></span><span class="k">worker_processes</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="k">user</span><span class="w"> </span><span class="s">nobody</span><span class="w"> </span><span class="s">nogroup</span><span class="p">;</span>
<span class="c1"># &#39;user nobody nobody;&#39; for systems with &#39;nobody&#39; as a group instead</span>
<span class="k">error_log</span><span class="w">  </span><span class="s">/var/log/nginx/error.log</span><span class="w"> </span><span class="s">warn</span><span class="p">;</span>
<span class="k">pid</span><span class="w"> </span><span class="s">/var/run/nginx.pid</span><span class="p">;</span>

<span class="k">events</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kn">worker_connections</span><span class="w"> </span><span class="mi">1024</span><span class="p">;</span><span class="w"> </span><span class="c1"># increase if you have lots of clients</span>
<span class="w">  </span><span class="kn">accept_mutex</span><span class="w"> </span><span class="no">off</span><span class="p">;</span><span class="w"> </span><span class="c1"># set to &#39;on&#39; if nginx worker_processes &gt; 1</span>
<span class="w">  </span><span class="c1"># &#39;use epoll;&#39; to enable for Linux 2.6+</span>
<span class="w">  </span><span class="c1"># &#39;use kqueue;&#39; to enable for FreeBSD, OSX</span>
<span class="p">}</span>

<span class="k">http</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kn">include</span><span class="w"> </span><span class="s">mime.types</span><span class="p">;</span>
<span class="w">  </span><span class="c1"># fallback in case we can&#39;t determine a type</span>
<span class="w">  </span><span class="kn">default_type</span><span class="w"> </span><span class="s">application/octet-stream</span><span class="p">;</span>
<span class="w">  </span><span class="kn">access_log</span><span class="w"> </span><span class="s">/var/log/nginx/access.log</span><span class="w"> </span><span class="s">combined</span><span class="p">;</span>
<span class="w">  </span><span class="kn">sendfile</span><span class="w"> </span><span class="no">on</span><span class="p">;</span>

<span class="w">  </span><span class="kn">upstream</span><span class="w"> </span><span class="s">app_server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1"># fail_timeout=0 means we always retry an upstream even if it failed</span>
<span class="w">    </span><span class="c1"># to return a good HTTP response</span>

<span class="w">    </span><span class="c1"># for UNIX domain socket setups</span>
<span class="w">    </span><span class="kn">server</span><span class="w"> </span><span class="s">unix:/tmp/gunicorn.sock</span><span class="w"> </span><span class="s">fail_timeout=0</span><span class="p">;</span>

<span class="w">    </span><span class="c1"># for a TCP configuration</span>
<span class="w">    </span><span class="c1"># server 192.168.0.7:8000 fail_timeout=0;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kn">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1"># if no Host match, close the connection to prevent host spoofing</span>
<span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="w"> </span><span class="s">default_server</span><span class="p">;</span>
<span class="w">    </span><span class="kn">return</span><span class="w"> </span><span class="mi">444</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kn">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1"># use &#39;listen 80 deferred;&#39; for Linux</span>
<span class="w">    </span><span class="c1"># use &#39;listen 80 accept_filter=httpready;&#39; for FreeBSD</span>
<span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<span class="w">    </span><span class="kn">client_max_body_size</span><span class="w"> </span><span class="s">4G</span><span class="p">;</span>

<span class="w">    </span><span class="c1"># set the correct host(s) for your site</span>
<span class="w">    </span><span class="kn">server_name</span><span class="w"> </span><span class="s">example.com</span><span class="w"> </span><span class="s">www.example.com</span><span class="p">;</span>

<span class="w">    </span><span class="kn">keepalive_timeout</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>

<span class="w">    </span><span class="c1"># path for static files</span>
<span class="w">    </span><span class="kn">root</span><span class="w"> </span><span class="s">/path/to/app/current/public</span><span class="p">;</span>

<span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="s">/</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1"># checks for static file, if not found proxy to app</span>
<span class="w">      </span><span class="kn">try_files</span><span class="w"> </span><span class="nv">$uri</span><span class="w"> </span><span class="s">@proxy_to_app</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="s">@proxy_to_app</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Forwarded-For</span><span class="w"> </span><span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
<span class="w">      </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Forwarded-Proto</span><span class="w"> </span><span class="nv">$scheme</span><span class="p">;</span>
<span class="w">      </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">Host</span><span class="w"> </span><span class="nv">$http_host</span><span class="p">;</span>
<span class="w">      </span><span class="c1"># we don&#39;t want nginx trying to do something clever with</span>
<span class="w">      </span><span class="c1"># redirects, we set the Host: header above already.</span>
<span class="w">      </span><span class="kn">proxy_redirect</span><span class="w"> </span><span class="no">off</span><span class="p">;</span>
<span class="w">      </span><span class="kn">proxy_pass</span><span class="w"> </span><span class="s">http://app_server</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kn">error_page</span><span class="w"> </span><span class="mi">500</span><span class="w"> </span><span class="mi">502</span><span class="w"> </span><span class="mi">503</span><span class="w"> </span><span class="mi">504</span><span class="w"> </span><span class="s">/500.html</span><span class="p">;</span>
<span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">/500.html</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kn">root</span><span class="w"> </span><span class="s">/path/to/app/current/public</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>If you want to be able to handle streaming request/responses or other fancy
features like Comet, Long polling, or Web sockets, you need to turn off the
proxy buffering. <strong>When you do this</strong> you must run with one of the async worker
classes.</p>
<p>To turn off buffering, you only need to add <code class="docutils literal notranslate"><span class="pre">proxy_buffering</span> <span class="pre">off;</span></code> to your
<code class="docutils literal notranslate"><span class="pre">location</span></code> block:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>...
location @proxy_to_app {
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_redirect off;
    proxy_buffering off;

    proxy_pass http://app_server;
}
...
</pre></div>
</div>
<p>If you want to ignore aborted requests like health check of Load Balancer, some
of which close the connection without waiting for a response, you need to turn
on <a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_ignore_client_abort">ignoring client abort</a>.</p>
<p>To ignore aborted requests, you only need to add
<code class="docutils literal notranslate"><span class="pre">proxy_ignore_client_abort</span> <span class="pre">on;</span></code> to your <code class="docutils literal notranslate"><span class="pre">location</span></code> block:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="n">proxy_ignore_client_abort</span> <span class="n">on</span><span class="p">;</span>
<span class="o">...</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The default value of <code class="docutils literal notranslate"><span class="pre">proxy_ignore_client_abort</span></code> is <code class="docutils literal notranslate"><span class="pre">off</span></code>. Error code
499 may appear in Nginx log and <code class="docutils literal notranslate"><span class="pre">Ignoring</span> <span class="pre">EPIPE</span></code> may appear in Gunicorn
log if loglevel is set to <code class="docutils literal notranslate"><span class="pre">debug</span></code>.</p>
</div>
<p>It is recommended to pass protocol information to Gunicorn. Many web
frameworks use this information to generate URLs. Without this
information, the application may mistakenly generate ‘http’ URLs in
‘https’ responses, leading to mixed content warnings or broken
applications. To configure Nginx to pass an appropriate header, add
a <code class="docutils literal notranslate"><span class="pre">proxy_set_header</span></code> directive to your <code class="docutils literal notranslate"><span class="pre">location</span></code> block:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>...
proxy_set_header X-Forwarded-Proto $scheme;
...
</pre></div>
</div>
<p>If you are running Nginx on a different host than Gunicorn you need to tell
Gunicorn to trust the <code class="docutils literal notranslate"><span class="pre">X-Forwarded-*</span></code> headers sent by Nginx. By default,
Gunicorn will only trust these headers if the connection comes from localhost.
This is to prevent a malicious client from forging these headers:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ gunicorn -w 3 --forwarded-allow-ips=&quot;10.170.3.217,10.170.3.220&quot; test:app
</pre></div>
</div>
<p>When the Gunicorn host is completely firewalled from the external network such
that all connections come from a trusted proxy (e.g. Heroku) this value can
be set to ‘*’. Using this value is <strong>potentially dangerous</strong> if connections to
Gunicorn may come from untrusted proxies or directly from clients since the
application may be tricked into serving SSL-only content over an insecure
connection.</p>
<p>Gunicorn 19 introduced a breaking change concerning how <code class="docutils literal notranslate"><span class="pre">REMOTE_ADDR</span></code> is
handled. Previous to Gunicorn 19 this was set to the value of
<code class="docutils literal notranslate"><span class="pre">X-Forwarded-For</span></code> if received from a trusted proxy. However, this was not in
compliance with <span class="target" id="index-0"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc3875.html"><strong>RFC 3875</strong></a> which is why the <code class="docutils literal notranslate"><span class="pre">REMOTE_ADDR</span></code> is now the IP
address of <strong>the proxy</strong> and <strong>not the actual user</strong>.</p>
<p>To have access logs indicate <strong>the actual user</strong> IP when proxied, set
<a class="reference internal" href="settings.html#access-log-format"><span class="std std-ref">access_log_format</span></a> with a format which includes <code class="docutils literal notranslate"><span class="pre">X-Forwarded-For</span></code>. For
example, this format uses <code class="docutils literal notranslate"><span class="pre">X-Forwarded-For</span></code> in place of <code class="docutils literal notranslate"><span class="pre">REMOTE_ADDR</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="p">({</span><span class="n">x</span><span class="o">-</span><span class="n">forwarded</span><span class="o">-</span><span class="k">for</span><span class="p">}</span><span class="n">i</span><span class="p">)</span><span class="n">s</span> <span class="o">%</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="n">s</span> <span class="o">%</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="n">s</span> <span class="o">%</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="n">s</span> <span class="s2">&quot;</span><span class="si">%(r)s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="n">s</span> <span class="o">%</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="n">s</span> <span class="s2">&quot;</span><span class="si">%(f)s</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="si">%(a)s</span><span class="s2">&quot;</span>
</pre></div>
</div>
<p>It is also worth noting that the <code class="docutils literal notranslate"><span class="pre">REMOTE_ADDR</span></code> will be completely empty if
you bind Gunicorn to a UNIX socket and not a TCP <code class="docutils literal notranslate"><span class="pre">host:port</span></code> tuple.</p>
</section>
<section id="using-virtualenv">
<h2>Using Virtualenv<a class="headerlink" href="#using-virtualenv" title="Permalink to this heading">¶</a></h2>
<p>To serve an app from a <a class="reference external" href="https://pypi.python.org/pypi/virtualenv">Virtualenv</a> it is generally easiest to just install
Gunicorn directly into the Virtualenv. This will create a set of Gunicorn
scripts for that Virtualenv which can be used to run applications normally.</p>
<p>If you have Virtualenv installed, you should be able to do something like
this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ mkdir ~/venvs/
$ virtualenv ~/venvs/webapp
$ source ~/venvs/webapp/bin/activate
$ pip install gunicorn
$ deactivate
</pre></div>
</div>
<p>Then you just need to use one of the three Gunicorn scripts that was installed
into <code class="docutils literal notranslate"><span class="pre">~/venvs/webapp/bin</span></code>.</p>
<p>Note: You can force the installation of Gunicorn in your Virtualenv by
passing <code class="docutils literal notranslate"><span class="pre">-I</span></code> or <code class="docutils literal notranslate"><span class="pre">--ignore-installed</span></code> option to pip:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ source ~/venvs/webapp/bin/activate
$ pip install -I gunicorn
</pre></div>
</div>
</section>
<section id="monitoring">
<h2>Monitoring<a class="headerlink" href="#monitoring" title="Permalink to this heading">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Make sure that when using either of these service monitors you do not
enable the Gunicorn’s daemon mode. These monitors expect that the process
they launch will be the process they need to monitor. Daemonizing will
fork-exec which creates an unmonitored process and generally just
confuses the monitor services.</p>
</div>
<section id="gaffer">
<h3>Gaffer<a class="headerlink" href="#gaffer" title="Permalink to this heading">¶</a></h3>
<section id="using-gafferd-and-gaffer">
<h4>Using Gafferd and gaffer<a class="headerlink" href="#using-gafferd-and-gaffer" title="Permalink to this heading">¶</a></h4>
<p><a class="reference external" href="https://gaffer.readthedocs.io/">Gaffer</a> can be used to monitor Gunicorn. A simple configuration is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">process</span><span class="p">:</span><span class="n">gunicorn</span><span class="p">]</span>
<span class="n">cmd</span> <span class="o">=</span> <span class="n">gunicorn</span> <span class="o">-</span><span class="n">w</span> <span class="mi">3</span> <span class="n">test</span><span class="p">:</span><span class="n">app</span>
<span class="n">cwd</span> <span class="o">=</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">project</span>
</pre></div>
</div>
<p>Then you can easily manage Gunicorn using <a class="reference external" href="https://gaffer.readthedocs.io/">Gaffer</a>.</p>
</section>
<section id="using-a-procfile">
<h4>Using a Procfile<a class="headerlink" href="#using-a-procfile" title="Permalink to this heading">¶</a></h4>
<p>Create a <code class="docutils literal notranslate"><span class="pre">Procfile</span></code> in your project:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gunicorn</span> <span class="o">=</span> <span class="n">gunicorn</span> <span class="o">-</span><span class="n">w</span> <span class="mi">3</span> <span class="n">test</span><span class="p">:</span><span class="n">app</span>
</pre></div>
</div>
<p>You can launch any other applications that should be launched at the same time.</p>
<p>Then you can start your Gunicorn application using <a class="reference external" href="https://gaffer.readthedocs.io/">Gaffer</a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gaffer</span> <span class="n">start</span>
</pre></div>
</div>
<p>If gafferd is launched you can also load your Procfile in it directly:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gaffer</span> <span class="n">load</span>
</pre></div>
</div>
<p>All your applications will be then supervised by gafferd.</p>
</section>
</section>
<section id="runit">
<h3>Runit<a class="headerlink" href="#runit" title="Permalink to this heading">¶</a></h3>
<p>A popular method for deploying Gunicorn is to have it monitored by <a class="reference external" href="http://smarden.org/runit/">runit</a>.
Here is an <a class="reference external" href="https://github.com/benoitc/gunicorn/blob/master/examples/gunicorn_rc">example service</a> definition:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/bin/sh

GUNICORN=/usr/local/bin/gunicorn
ROOT=/path/to/project
PID=/var/run/gunicorn.pid

APP=main:application

if [ -f $PID ]; then rm $PID; fi

cd $ROOT
exec $GUNICORN -c $ROOT/gunicorn.conf.py --pid=$PID $APP
</pre></div>
</div>
<p>Save this as <code class="docutils literal notranslate"><span class="pre">/etc/sv/[app_name]/run</span></code>, and make it executable
(<code class="docutils literal notranslate"><span class="pre">chmod</span> <span class="pre">u+x</span> <span class="pre">/etc/sv/[app_name]/run</span></code>).
Then run <code class="docutils literal notranslate"><span class="pre">ln</span> <span class="pre">-s</span> <span class="pre">/etc/sv/[app_name]</span> <span class="pre">/etc/service/[app_name]</span></code>.
If runit is installed, Gunicorn should start running automatically as soon
as you create the symlink.</p>
<p>If it doesn’t start automatically, run the script directly to troubleshoot.</p>
</section>
<section id="supervisor">
<h3>Supervisor<a class="headerlink" href="#supervisor" title="Permalink to this heading">¶</a></h3>
<p>Another useful tool to monitor and control Gunicorn is <a class="reference external" href="http://supervisord.org/">Supervisor</a>. A
<a class="reference external" href="https://github.com/benoitc/gunicorn/blob/master/examples/supervisor.conf">simple configuration</a> is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">program</span><span class="p">:</span><span class="n">gunicorn</span><span class="p">]</span>
<span class="n">command</span><span class="o">=/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">gunicorn</span> <span class="n">main</span><span class="p">:</span><span class="n">application</span> <span class="o">-</span><span class="n">c</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">gunicorn</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">py</span>
<span class="n">directory</span><span class="o">=/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">project</span>
<span class="n">user</span><span class="o">=</span><span class="n">nobody</span>
<span class="n">autostart</span><span class="o">=</span><span class="n">true</span>
<span class="n">autorestart</span><span class="o">=</span><span class="n">true</span>
<span class="n">redirect_stderr</span><span class="o">=</span><span class="n">true</span>
</pre></div>
</div>
</section>
<section id="upstart">
<h3>Upstart<a class="headerlink" href="#upstart" title="Permalink to this heading">¶</a></h3>
<p>Using Gunicorn with upstart is simple. In this example we will run the app
“myapp” from a virtualenv. All errors will go to
<code class="docutils literal notranslate"><span class="pre">/var/log/upstart/myapp.log</span></code>.</p>
<p><strong>/etc/init/myapp.conf</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">description</span> <span class="s2">&quot;myapp&quot;</span>

<span class="n">start</span> <span class="n">on</span> <span class="p">(</span><span class="n">filesystem</span><span class="p">)</span>
<span class="n">stop</span> <span class="n">on</span> <span class="n">runlevel</span> <span class="p">[</span><span class="mi">016</span><span class="p">]</span>

<span class="n">respawn</span>
<span class="n">setuid</span> <span class="n">nobody</span>
<span class="n">setgid</span> <span class="n">nogroup</span>
<span class="n">chdir</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">directory</span>

<span class="n">exec</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">virtualenv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">gunicorn</span> <span class="n">myapp</span><span class="p">:</span><span class="n">app</span>
</pre></div>
</div>
</section>
<section id="systemd">
<h3>Systemd<a class="headerlink" href="#systemd" title="Permalink to this heading">¶</a></h3>
<p>A tool that is starting to be common on linux systems is <a class="reference external" href="https://www.freedesktop.org/wiki/Software/systemd/">Systemd</a>. It is a
system services manager that allows for strict process management, resources
and permissions control.</p>
<p>Below are configuration files and instructions for using systemd to create
a unix socket for incoming Gunicorn requests.  Systemd will listen on this
socket and start gunicorn automatically in response to traffic.  Later in
this section are instructions for configuring Nginx to forward web traffic
to the newly created unix socket:</p>
<p><strong>/etc/systemd/system/gunicorn.service</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[Unit]
Description=gunicorn daemon
Requires=gunicorn.socket
After=network.target

[Service]
Type=notify
# the specific user that our service will run as
User=someuser
Group=someuser
# another option for an even more restricted service is
# DynamicUser=yes
# see http://0pointer.net/blog/dynamic-users-with-systemd.html
RuntimeDirectory=gunicorn
WorkingDirectory=/home/someuser/applicationroot
ExecStart=/usr/bin/gunicorn applicationname.wsgi
ExecReload=/bin/kill -s HUP $MAINPID
KillMode=mixed
TimeoutStopSec=5
PrivateTmp=true

[Install]
WantedBy=multi-user.target
</pre></div>
</div>
<p><strong>/etc/systemd/system/gunicorn.socket</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">Unit</span><span class="p">]</span>
<span class="n">Description</span><span class="o">=</span><span class="n">gunicorn</span> <span class="n">socket</span>

<span class="p">[</span><span class="n">Socket</span><span class="p">]</span>
<span class="n">ListenStream</span><span class="o">=/</span><span class="n">run</span><span class="o">/</span><span class="n">gunicorn</span><span class="o">.</span><span class="n">sock</span>
<span class="c1"># Our service won&#39;t need permissions for the socket, since it</span>
<span class="c1"># inherits the file descriptor by socket activation</span>
<span class="c1"># only the nginx daemon will need access to the socket</span>
<span class="n">SocketUser</span><span class="o">=</span><span class="n">www</span><span class="o">-</span><span class="n">data</span>
<span class="c1"># Optionally restrict the socket permissions even more.</span>
<span class="c1"># SocketMode=600</span>

<span class="p">[</span><span class="n">Install</span><span class="p">]</span>
<span class="n">WantedBy</span><span class="o">=</span><span class="n">sockets</span><span class="o">.</span><span class="n">target</span>
</pre></div>
</div>
<p>Next enable and start the socket (it will autostart at boot too):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">enable</span> <span class="o">--</span><span class="n">now</span> <span class="n">gunicorn</span><span class="o">.</span><span class="n">socket</span>
</pre></div>
</div>
<p>Now let’s see if the nginx daemon will be able to connect to the socket.
Running <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">-u</span> <span class="pre">www-data</span> <span class="pre">curl</span> <span class="pre">--unix-socket</span> <span class="pre">/run/gunicorn.sock</span> <span class="pre">http</span></code>,
our Gunicorn service will be automatically started and you should see some
HTML from your server in the terminal.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>systemd employs cgroups to track the processes of a service, so it doesn’t
need pid files. In the rare case that you need to find out the service main
pid, you can use <code class="docutils literal notranslate"><span class="pre">systemctl</span> <span class="pre">show</span> <span class="pre">--value</span> <span class="pre">-p</span> <span class="pre">MainPID</span> <span class="pre">gunicorn.service</span></code>, but
if you only want to send a signal an even better option is
<code class="docutils literal notranslate"><span class="pre">systemctl</span> <span class="pre">kill</span> <span class="pre">-s</span> <span class="pre">HUP</span> <span class="pre">gunicorn.service</span></code>.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">www-data</span></code> is the default nginx user in debian, other distributions use
different users (for example: <code class="docutils literal notranslate"><span class="pre">http</span></code> or <code class="docutils literal notranslate"><span class="pre">nginx</span></code>). Check your distro to
know what to put for the socket user, and for the sudo command.</p>
</div>
<p>You must now configure your web proxy to send traffic to the new Gunicorn
socket. Edit your <code class="docutils literal notranslate"><span class="pre">nginx.conf</span></code> to include the following:</p>
<p><strong>/etc/nginx/nginx.conf</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">user</span> <span class="n">www</span><span class="o">-</span><span class="n">data</span><span class="p">;</span>
<span class="o">...</span>
<span class="n">http</span> <span class="p">{</span>
    <span class="n">server</span> <span class="p">{</span>
        <span class="n">listen</span>          <span class="mi">8000</span><span class="p">;</span>
        <span class="n">server_name</span>     <span class="mf">127.0.0.1</span><span class="p">;</span>
        <span class="n">location</span> <span class="o">/</span> <span class="p">{</span>
            <span class="n">proxy_pass</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">unix</span><span class="p">:</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">gunicorn</span><span class="o">.</span><span class="n">sock</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="o">...</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The listen and server_name used here are configured for a local machine.
In a production server you will most likely listen on port 80,
and use your URL as the server_name.</p>
</div>
<p>Now make sure you enable the nginx service so it automatically starts at boot:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">enable</span> <span class="n">nginx</span><span class="o">.</span><span class="n">service</span>
</pre></div>
</div>
<p>Either reboot, or start Nginx with the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">start</span> <span class="n">nginx</span>
</pre></div>
</div>
<p>Now you should be able to test Nginx with Gunicorn by visiting
<a class="reference external" href="http://127.0.0.1:8000/">http://127.0.0.1:8000/</a> in any web browser. Systemd is now set up.</p>
</section>
</section>
<section id="logging">
<h2>Logging<a class="headerlink" href="#logging" title="Permalink to this heading">¶</a></h2>
<p>Logging can be configured by using various flags detailed in the
<a class="reference external" href="http://docs.gunicorn.org/en/latest/settings.html#logging">configuration documentation</a> or by creating a <a class="reference external" href="https://github.com/benoitc/gunicorn/blob/master/examples/logging.conf">logging configuration file</a>.
Send the <code class="docutils literal notranslate"><span class="pre">USR1</span></code> signal to rotate logs if you are using the logrotate
utility:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>kill -USR1 $(cat /var/run/gunicorn.pid)
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Overriding the <code class="docutils literal notranslate"><span class="pre">LOGGING</span></code> dictionary requires to set
<code class="docutils literal notranslate"><span class="pre">disable_existing_loggers:</span> <span class="pre">False</span></code> to not interfere with the Gunicorn
logging.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Gunicorn error log is here to log errors from Gunicorn, not from another
application.</p>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="instrumentation.html" class="btn btn-neutral float-left" title="Instrumentation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="signals.html" class="btn btn-neutral float-right" title="Signal Handling" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2009-2023, Benoit Chesneau.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>