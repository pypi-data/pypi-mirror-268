(this.webpackJsonpstreamlit_component_template=this.webpackJsonpstreamlit_component_template||[]).push([[0],{18:function(t,e,s){"use strict";s.r(e);var i=s(1),r=s.n(i),n=s(5),a=s.n(n),o=s(2),h=s(8),l=s(6),c=s(3);o.b.add(h.a);class u extends c.b{constructor(t){super(t),this.stream=null,this.AudioContext=window.AudioContext||window.webkitAudioContext,this.type="audio/wav",this.sampleRate=null,this.phrase_buffer_count=null,this.pause_buffer_count=null,this.pause_count=0,this.stage=null,this.volume=null,this.audioInput=null,this.analyser=null,this.recorder=null,this.recording=!1,this.leftchannel=[],this.rightchannel=[],this.leftBuffer=null,this.rightBuffer=null,this.recordingLength=0,this.tested=!1,this.getStream=()=>navigator.mediaDevices.getUserMedia({audio:!0,video:!1}),this.setupMic=async()=>{try{window.stream=this.stream=await this.getStream()}catch(t){console.log("Error: Issue getting mic",t)}this.startRecording()},this.closeMic=()=>{this.stream.getAudioTracks().forEach(t=>{t.stop()}),this.audioInput.disconnect(0),this.analyser.disconnect(0),this.recorder.disconnect(0)},this.writeUTFBytes=(t,e,s)=>{let i=s.length;for(let r=0;r<i;r++)t.setUint8(e+r,s.charCodeAt(r))},this.mergeBuffers=(t,e)=>{let s=new Float32Array(e),i=0,r=t.length;for(let n=0;n<r;n++){let e=t[n];s.set(e,i),i+=e.length}return s},this.interleave=(t,e)=>{let s=t.length+e.length,i=new Float32Array(s),r=0;for(let n=0;n<s;)i[n++]=t[r],i[n++]=e[r],r++;return i},this.startRecording=()=>{let t=this.props.args.sample_rate;null===t?(this.context=new this.AudioContext,this.sampleRate=this.context.sampleRate):(this.context=new this.AudioContext({sampleRate:t}),this.sampleRate=t),console.log("Sample rate ".concat(this.sampleRate,"Hz"));let e=2048/this.sampleRate;this.pause_buffer_count=Math.ceil(this.props.args.pause_threshold/e),this.pause_count=0,this.stage="start",this.volume=this.context.createGain(),this.audioInput=this.context.createMediaStreamSource(this.stream),this.analyser=this.context.createAnalyser(),this.audioInput.connect(this.analyser),this.recorder=this.context.createScriptProcessor(2048,2,2),this.analyser.connect(this.recorder),this.recorder.connect(this.context.destination);const s=this;this.recorder.onaudioprocess=function(t){if(!s.recording)return;let e=t.inputBuffer.getChannelData(0),i=t.inputBuffer.getChannelData(1);s.tested||(s.tested=!0,e.reduce((t,e)=>t+e)||(console.log("Error: There seems to be an issue with your Mic"),s.stop(),s.stream.getTracks().forEach((function(t){t.stop()})),s.context.close()));let r=Math.sqrt(e.map(t=>t*t).reduce((t,e)=>t+e)/e.length);"start"===s.stage&&r>s.props.args.start_threshold?s.stage="speaking":"speaking"===s.stage&&(r>s.props.args.end_threshold?s.pause_count=0:(s.pause_count+=1,s.pause_count>s.pause_buffer_count&&s.stop())),s.leftchannel.push(new Float32Array(e)),s.rightchannel.push(new Float32Array(i)),s.recordingLength+=2048}},this.start=async()=>{this.recording=!0,this.setState({color:this.props.args.recording_color}),await this.setupMic(),this.leftchannel.length=this.rightchannel.length=0,this.recordingLength=0},this.stop=async()=>{this.recording=!1,this.setState({color:this.props.args.neutral_color}),this.closeMic(),console.log(this.recordingLength),this.leftBuffer=this.mergeBuffers(this.leftchannel,this.recordingLength),this.rightBuffer=this.mergeBuffers(this.rightchannel,this.recordingLength);let t=this.interleave(this.leftBuffer,this.rightBuffer),e=new ArrayBuffer(44+2*t.length),s=new DataView(e);this.writeUTFBytes(s,0,"RIFF"),s.setUint32(4,44+2*t.length,!0),this.writeUTFBytes(s,8,"WAVE"),this.writeUTFBytes(s,12,"fmt "),s.setUint32(16,16,!0),s.setUint16(20,1,!0),s.setUint16(22,2,!0),s.setUint32(24,this.sampleRate,!0),s.setUint32(28,4*this.sampleRate,!0),s.setUint16(32,4,!0),s.setUint16(34,16,!0),this.writeUTFBytes(s,36,"data"),s.setUint32(40,2*t.length,!0);let i=t.length,r=44;for(let o=0;o<i;o++)s.setInt16(r,32767*t[o],!0),r+=2;const n=new Blob([s],{type:this.type}),a=URL.createObjectURL(n);await this.onStop({blob:n,url:a,type:this.type})},this.render=()=>{if(this.props.args.invisible)return"";{const{theme:t}=this.props,e=this.props.args.text;return r.a.createElement("span",null,e," \xa0",r.a.createElement(l.a,{icon:this.props.args.icon_name,onClick:this.onClicked,style:{color:this.state.color},size:this.props.args.icon_size}))}},this.onClicked=async()=>{this.recording?await this.stop():await this.start()},this.onStop=async t=>{var e=await t.blob.arrayBuffer(),s=JSON.stringify(Array.from(new Uint8Array(e)));c.a.setComponentValue(s)},this.state={color:this.props.args.neutral_color},this.props.args.auto_start}componentDidMount(){this.props.args.auto_start&&this.start()}}var p=Object(c.c)(u);a.a.render(r.a.createElement(r.a.StrictMode,null,r.a.createElement(p,null)),document.getElementById("root"))},9:function(t,e,s){t.exports=s(18)}},[[9,1,2]]]);
//# sourceMappingURL=main.a2096f18.chunk.js.map